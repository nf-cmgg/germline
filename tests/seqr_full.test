nextflow_pipeline {

    name "The full Seqr mode test"
    script "main.nf"

    test("Success") {

        when {
            params {
                output_mode         = "seqr"
                use_dragstr_model   = true
                always_use_cram     = true
            }
        }

        then {
            assert workflow.success
            assert path("${outputDir}/ready/Proband_12345/reports/Proband_12345.TsTv.count").md5 == "dd579177c21fb1802e98e801e0525291"
            assert path("${outputDir}/ready/Proband_12345/reports/Proband_12345.bcftools_stats.txt").md5 == "87e6d7e19caf6f2a095f5f34ea175852"
            assert file("${outputDir}/ready/Proband_12345/reports/Proband_12345.TsTv.qual").exists()
            assert path("${outputDir}/ready/Proband_12345/reports/Proband_12345.FILTER.summary").md5 == "2aa3fe1aaddec8c8687d6590bc58ba81"
            assert path("${outputDir}/ready/Proband_12345/Proband_12345.vcf.gz").linesGzip.contains("chr21\t6448991\t.\tG\tC\t31.64\t.\tAC=1;AF=0.500;AN=2;AS_QD=2.91;BaseQRankSum=2.74;DP=28;ExcessHet=0.0000;FS=0.000;MLEAC=1;MLEAF=0.500;MQ=19.21;MQRankSum=-9.800e-01;QD=2.88;ReadPosRankSum=0.992;SOR=0.180\tGT:AD:DP:GQ:PL\t./.:17,0:17:40\t0/1:8,3:11:21:39,0,21")
            assert file("${outputDir}/ready/Proband_12345/Proband_12345.vcf.gz.tbi").exists()
            assert path("${outputDir}/individuals/NA24385D2_NVQ_034/NA24385D2_NVQ_034.g.vcf.gz").linesGzip.contains("chr21\t2\t.\tN\t<NON_REF>\t.\t.\tEND=6118038\tGT:DP:GQ:MIN_DP:PL\t0/0:0:0:0:0,0,0")
            assert file("${outputDir}/individuals/NA24385D2_NVQ_034/NA24385D2_NVQ_034.g.vcf.gz.tbi").exists()
            assert path("${outputDir}/individuals/NA12878K12_NVQ_034/NA12878K12_NVQ_034.g.vcf.gz").linesGzip.contains("chr21\t2\t.\tN\t<NON_REF>\t.\t.\tEND=6118023\tGT:DP:GQ:MIN_DP:PL\t0/0:0:0:0:0,0,0")
            assert file("${outputDir}/individuals/NA12878K12_NVQ_034/NA12878K12_NVQ_034.g.vcf.gz.tbi").exists()
            assert file("${outputDir}/multiqc_reports/multiqc_report.html").exists()
        }
    }
}
