nextflow_pipeline {

    name "The seqplorer mode tests with VCFanno"
    script "main.nf"

    test("Success") {

        when {
            params {
                output_mode = "seqplorer"

                vcfanno           = true
                vcfanno_toml      = "https://github.com/nf-core/test-datasets/raw/modules/data/genomics/homo_sapiens/genome/vcf/vcfanno/vcfanno.toml"
                vcfanno_resources = "https://github.com/nf-core/test-datasets/raw/modules/data/genomics/homo_sapiens/genome/vcf/vcfanno/vcfanno_grch38_module_test.tar.gz"

            }
        }

        then {
            assert workflow.success
            assert path("${outputDir}/families/Proband_12345/reports/Proband_12345.TsTv.count").md5 == "c4c5d1d04ad9090639c3524736a4b60e"
            assert path("${outputDir}/families/Proband_12345/reports/Proband_12345.bcftools_stats.txt").md5 == "c4ebf9494e991f6c40b1d428a3c23a7e"
            assert file("${outputDir}/families/Proband_12345/reports/Proband_12345.TsTv.qual").exists()
            assert path("${outputDir}/families/Proband_12345/reports/Proband_12345.FILTER.summary").md5 == "b09c0ae633ce5b66cb33e0a3ad046954"
            assert path("${outputDir}/families/Proband_12345/Proband_12345.ann.vcf.gz").linesGzip.contains("chr21\t6448991\t.\tG\tC\t31.6\tGATKCutoffSNP\tAC=1;AF=0.5;AN=2;AS_QD=2.91;BaseQRankSum=2.74;DP=28;ExcessHet=0;FS=0;MLEAC=1;MLEAF=0.5;MQ=19.21;MQRankSum=-0.98;QD=2.88;ReadPosRankSum=0.992;SOR=0.18;CSQ=C|intron_variant|MODIFIER|CBSL|ENSG00000274276|Transcript|ENST00000398168|protein_coding||15/16|ENST00000398168.6:c.1468-426C>G||||||||1||-1||SNV|HGNC|HGNC:51829|YES|NM_001354009.3||1|P4|CCDS82646.1|ENSP00000381234|P0DN79.36||UPI0000036BC5||||||||chr21:g.6448991G>C||||||||||||||||||||||||||||||\tGT:AD:DP:GQ:PL\t./.:17,0:17:40:.\t0/1:8,3:11:21:39,0,21")
            assert file("${outputDir}/families/Proband_12345/Proband_12345.db").exists()
            assert path("${outputDir}/families/Proband_12345/Proband_12345_filtered_snps_indels.vcf.gz").linesGzip.contains("chr21\t6448991\t.\tG\tC\t31.64\tGATKCutoffSNP\tAC=1;AF=0.5;AN=2;AS_QD=2.91;BaseQRankSum=2.74;DP=28;ExcessHet=0;FS=0;MLEAC=1;MLEAF=0.5;MQ=19.21;MQRankSum=-0.98;QD=2.88;ReadPosRankSum=0.992;SOR=0.18\tGT:AD:DP:GQ:PL\t./.:17,0:17:40:.\t0/1:8,3:11:21:39,0,21")
            assert path("${outputDir}/individuals/NA24385D2_NVQ_034/NA24385D2_NVQ_034.g.vcf.gz").linesGzip.contains("chr21\t2\t.\tN\t<NON_REF>\t.\t.\tEND=6118038\tGT:DP:GQ:MIN_DP:PL\t0/0:0:0:0:0,0,0")
            assert file("${outputDir}/individuals/NA24385D2_NVQ_034/NA24385D2_NVQ_034.g.vcf.gz.tbi").exists()
            assert path("${outputDir}/individuals/NA12878K12_NVQ_034/NA12878K12_NVQ_034.g.vcf.gz").linesGzip.contains("chr21\t2\t.\tN\t<NON_REF>\t.\t.\tEND=6118023\tGT:DP:GQ:MIN_DP:PL\t0/0:0:0:0:0,0,0")
            assert file("${outputDir}/individuals/NA12878K12_NVQ_034/NA12878K12_NVQ_034.g.vcf.gz.tbi").exists()
            assert file("${outputDir}/multiqc_reports/multiqc_report.html").exists()
        }
    }
}
